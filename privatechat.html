<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Private Chat</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #121212;
      color: white;
    }
    .header {
      background: #1f1f1f;
      padding: 15px;
      text-align: center;
      font-size: 20px;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 10;
    }
    .chat-container {
      margin-top: 60px;
      padding: 10px;
      height: 80vh;
      overflow-y: scroll;
    }
    .message {
      background: #333;
      margin: 10px 0;
      padding: 10px;
      border-radius: 10px;
      max-width: 70%;
    }
    .me {
      background: #4CAF50;
      margin-left: auto;
      color: white;
    }
    .friend {
      background: #2d2d2d;
      margin-right: auto;
    }
    .input-area {
      position: fixed;
      bottom: 0;
      width: 100%;
      display: flex;
      background: #1f1f1f;
      padding: 10px;
    }
    .input-area input {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 20px;
      margin-right: 10px;
    }
    .input-area button {
      background: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="header" id="chatWith">Chat</div>

<div class="chat-container" id="chatBox">
  <!-- Messages will appear here -->
</div>

<div class="input-area">
  <input type="text" id="messageInput" placeholder="Type your message...">
  <button onclick="sendMessage()">Send</button>
</div>

<script>
  const db = firebase.firestore();
  const auth = firebase.auth();
  let currentUser, friendId;

  function getFriendId() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('friendId');
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      friendId = getFriendId();

      if (!friendId) {
        alert("No friend selected.");
        window.location.href = 'chatlist.html';
        return;
      }

      document.getElementById('chatWith').innerText = "Chat with: " + friendId;

      // Listen for messages between currentUser and friend
      db.collection("privateChats")
        .doc(getChatId(currentUser.uid, friendId))
        .collection("messages")
        .orderBy("timestamp")
        .onSnapshot(snapshot => {
          const chatBox = document.getElementById("chatBox");
          chatBox.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message");
            messageDiv.classList.add(data.sender === currentUser.uid ? "me" : "friend");
            messageDiv.innerText = data.message;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
          });
        });
    } else {
      alert("Not signed in");
      window.location.href = 'login.html';
    }
  });

  function getChatId(uid1, uid2) {
    return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
  }

  function sendMessage() {
    const message = document.getElementById("messageInput").value.trim();
    if (message === "") return;

    const chatId = getChatId(currentUser.uid, friendId);

    db.collection("privateChats")
      .doc(chatId)
      .collection("messages")
      .add({
        sender: currentUser.uid,
        receiver: friendId,
        message: message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

    document.getElementById("messageInput").value = "";
  }
</script>

</body>
  </html>
